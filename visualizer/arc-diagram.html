<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECT 159 - Biblical Cross-Reference Visualizer</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .header-custom {
            background: linear-gradient(135deg, #ff6b9d 0%, #c94b4b 100%);
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }
        .header-custom h1 {
            margin: 0;
            font-size: 2.8em;
            font-weight: bold;
        }
        .header-custom p {
            margin: 15px 0 5px 0;
            font-size: 1.3em;
            opacity: 0.95;
        }
        .header-custom .subtitle {
            font-size: 1em;
            opacity: 0.85;
        }
        .info-panel {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 107, 157, 0.3);
        }
        .info-panel h2 {
            color: var(--accent-gold);
            margin-top: 0;
        }
        .info-panel ul {
            line-height: 1.8;
        }
        .info-panel strong {
            color: var(--accent-cyan);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 107, 157, 0.1);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid rgba(255, 107, 157, 0.3);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-cyan);
        }
        .stat-card.clickable {
            cursor: pointer;
        }
        .stat-card.clickable:hover {
            background: rgba(255, 107, 157, 0.2);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            overflow-y: auto;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid rgba(255, 107, 157, 0.5);
            border-radius: 12px;
            width: 80%;
            max-width: 900px;
            box-shadow: 0 10px 40px rgba(255, 107, 157, 0.3);
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }
        .modal-close:hover {
            color: var(--accent-gold);
        }
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .book-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid;
            font-size: 0.9em;
        }
        .book-item.protestant {
            border-left-color: #00CED1;
        }
        .book-item.deuterocanonical {
            border-left-color: #9370DB;
        }
        .book-item.ethiopian {
            border-left-color: #ff6b9d;
        }
        .book-item.dss {
            border-left-color: #00BFFF;
        }
        .book-item.gnostic {
            border-left-color: #888888;
        }
        .book-item.lost {
            border-left-color: #ffa500;
            opacity: 0.7;
        }
        .canon-section {
            margin-bottom: 30px;
        }
        .canon-section h3 {
            color: var(--accent-gold);
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 107, 157, 0.3);
            padding-bottom: 10px;
        }
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: var(--accent-gold);
            margin: 0;
        }
        .stat-label {
            color: var(--text-secondary);
            margin-top: 10px;
            font-size: 1.1em;
        }
        .tab-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            background: rgba(255, 0, 0, 0.2);
            border-color: #FF0000;
        }
        .tab-btn.active {
            background: rgba(255, 0, 0, 0.3);
            border-color: #FF0000;
            color: #fff;
        }
        .noncanon-row {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .noncanon-row:hover {
            background: rgba(255, 0, 0, 0.1);
        }
        .noncanon-row td {
            padding: 10px 12px;
        }
        .type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .type-badge.Deuterocanonical { background: rgba(147, 112, 219, 0.3); color: #9370DB; }
        .type-badge.Ethiopian { background: rgba(255, 107, 157, 0.3); color: #ff6b9d; }
        .type-badge.Gnostic { background: rgba(136, 136, 136, 0.3); color: #888888; }
        .type-badge.Lost { background: rgba(255, 165, 0, 0.3); color: #ffa500; }

        /* Book items clickable */
        .book-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .book-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        /* Text Viewer Modal */
        .text-viewer-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            overflow-y: auto;
        }
        .text-viewer-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 2% auto;
            padding: 30px;
            border: 2px solid rgba(255, 107, 157, 0.5);
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 10px 40px rgba(255, 107, 157, 0.3);
            position: relative;
        }
        .text-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 107, 157, 0.3);
        }
        .text-viewer-title {
            color: var(--accent-gold);
            font-size: 1.8em;
            margin: 0;
        }
        .close-viewer-btn {
            background: rgba(255, 68, 68, 0.3);
            border: 1px solid #ff4444;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        .close-viewer-btn:hover {
            background: #ff4444;
        }
        .chapter-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .chapter-btn {
            background: rgba(255, 107, 157, 0.2);
            border: 1px solid rgba(255, 107, 157, 0.5);
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .chapter-btn:hover:not(:disabled) {
            background: rgba(255, 107, 157, 0.4);
        }
        .chapter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .chapter-selector select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--accent-gold);
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
        }
        .text-viewer-body {
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-radius: 8px;
            line-height: 1.8;
            font-size: 1.05em;
            max-height: 60vh;
            overflow-y: auto;
        }
        .verse {
            margin: 8px 0;
        }
        .verse-num {
            color: var(--accent-gold);
            font-weight: bold;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- Navigation Menu -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="table-view.html" class="nav-logo">üìú PROJECT 159</a>
            <button class="nav-toggle" onclick="toggleNav()">‚ò∞</button>
            <ul class="nav-links" id="nav-links">
                <li><a href="table-view.html" class="nav-link">üìä Cross-References</a></li>
                <li><a href="arc-diagram.html" class="nav-link active">üåà Arc Diagram</a></li>
                <li><a href="library.html" class="nav-link">üìö Library</a></li>
                <li><a href="timeline.html" class="nav-link">üìÖ Timeline</a></li>
                <li><a href="history.html" class="nav-link">üìñ History</a></li>
                <li><a href="donate.html" class="nav-link">üíõ Donate</a></li>
            </ul>
        </div>
    </nav>
    <style>
        .main-nav {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-bottom: 2px solid rgba(255, 107, 157, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 0 20px;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        .nav-logo {
            font-size: 1.4em;
            font-weight: bold;
            color: #FFD700;
            text-decoration: none;
        }
        .nav-logo:hover { color: #fff; }
        .nav-links {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 10px;
        }
        .nav-link {
            color: #ccc;
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 0.95em;
        }
        .nav-link:hover {
            background: rgba(255, 107, 157, 0.2);
            color: #fff;
        }
        .nav-link.active {
            background: rgba(255, 107, 157, 0.3);
            color: #FFD700;
            border: 1px solid rgba(255, 107, 157, 0.5);
        }
        .nav-toggle {
            display: none;
            background: none;
            border: 2px solid #FFD700;
            color: #FFD700;
            font-size: 1.5em;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        @media (max-width: 768px) {
            .nav-toggle { display: block; }
            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: #1a1a2e;
                flex-direction: column;
                padding: 15px;
                border-bottom: 2px solid rgba(255, 107, 157, 0.3);
            }
            .nav-links.active { display: flex; }
            .nav-link { padding: 12px 15px; }
        }
    </style>
    <script>
        function toggleNav() {
            document.getElementById('nav-links').classList.toggle('active');
        }
    </script>

    <div class="container">
        <!-- Custom Header -->
        <div class="header-custom">
            <h1>üìú PROJECT 159 - Biblical Cross-Reference Visualizer</h1>
            <p>159 Books Across All Biblical Traditions</p>
            <p class="subtitle">Protestant 66 + Deuterocanonical 14 + Ethiopian 21 + Dead Sea Scrolls 10 + Gnostic 22 + Lost 26</p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card clickable" id="books-card" onclick="showBooksModal()">
                <div class="stat-number">159</div>
                <div class="stat-label">Total Books (Click to view)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">345K+</div>
                <div class="stat-label">Cross-References</div>
            </div>
            <div class="stat-card clickable" id="noncanon-card" onclick="showNonCanonModal()">
                <div class="stat-number" id="noncanon-count">Loading...</div>
                <div class="stat-label">Non-Canon Cross-Refs (Click to view)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">2,000+</div>
                <div class="stat-label">Total Chapters</div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel">
            <h2>About This Visualization</h2>
            <p>This arc diagram shows cross-references between all 159 books across biblical traditions:</p>
            <ul>
                <li><strong style="color: #00CED1;">66 Protestant Books</strong> - Genesis through Revelation (OT 39 + NT 27)</li>
                <li><strong style="color: #9370DB;">14 Deuterocanonical Books</strong> - Tobit, Judith, Wisdom, Sirach, Baruch, 1-2 Maccabees, Susanna, Bel & Dragon, Prayer of Azariah, Greek Esther, 1-2 Esdras, Prayer of Manasseh</li>
                <li><strong style="color: #ff6b9d;">21 Ethiopian/Pseudepigrapha</strong> - 1-3 Enoch, Jubilees, 2-4 Baruch, 3-4 Maccabees, Testaments, and more</li>
                <li><strong style="color: #00BFFF;">10 Dead Sea Scrolls</strong> - Community Rule, War Scroll, Temple Scroll, Damascus Document, and more from Qumran</li>
                <li><strong style="color: #888888;">22 Gnostic/Early Christian</strong> - Gospel of Thomas, Gospel of Judas, Didache, Shepherd of Hermas, and more</li>
                <li><strong style="color: #ffa500;">26 Lost Books</strong> - Referenced in Scripture but lost to history</li>
            </ul>
            <p><strong>How to use:</strong> Hover over arcs to see connections. Click "159 Total Books" to see the complete list. Rainbow colors represent distance between connected chapters.</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label for="testament-filter">Testament:</label>
                <select id="testament-filter">
                    <option value="all">All</option>
                    <option value="OT">Old Testament</option>
                    <option value="NT">New Testament</option>
                    <option value="cross">OT ‚Üî NT</option>
                </select>
            </div>

            <div class="control-group">
                <label for="min-connections">Min Connections:</label>
                <input type="range" id="min-connections" min="1" max="50" value="1">
                <span id="min-value">1</span>
            </div>

            <button id="reset-btn" class="btn">Reset View</button>
            <button id="export-svg-btn" class="btn btn-theme">üì• Export SVG</button>
        </div>

        <!-- Visualization Area -->
        <div class="viz-container">
            <div id="arc-viz" class="viz-panel active">
                <div class="viz-info">
                    <h3>Arc Diagram - 159 Books</h3>
                    <p>Visualization of cross-references using circular arcs. Rainbow gradient colors represent distance between connected chapters.</p>
                </div>
                <svg id="arc-svg"></svg>
                <div id="arc-tooltip" class="tooltip"></div>
            </div>
        </div>

        <!-- Non-Canonical Cross-References Section - Full Database -->
        <div class="info-panel" style="margin-top: 30px;">
            <h2>üî¥ Non-Canonical Cross-References (<span id="notable-count">Loading...</span> Total)</h2>
            <p style="margin-bottom: 15px;">These cross-references connect canonical Scripture to non-canonical texts. Displayed as colored arcs in the visualization above.</p>

            <!-- Arc Legend -->
            <div style="display: flex; gap: 25px; margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; flex-wrap: wrap; align-items: center;">
                <span style="font-weight: bold; color: var(--accent-gold);">Arc Legend:</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 40px; height: 4px; background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3); border-radius: 2px;"></div>
                    <span style="color: #ccc;">RAINBOW</span>
                    <span style="color: #aaa;">= OT ‚Üî NT (distance)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 40px; height: 4px; background: #FF0000; border-radius: 2px; box-shadow: 0 0 8px #FF0000;"></div>
                    <span style="color: #FF0000;">RED</span>
                    <span style="color: #aaa;">= Deuterocanonical</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 40px; height: 4px; background: #ff6b9d; border-radius: 2px; box-shadow: 0 0 8px #ff6b9d;"></div>
                    <span style="color: #ff6b9d;">PINK</span>
                    <span style="color: #aaa;">= Ethiopian</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 40px; height: 4px; background: #000000; border-radius: 2px; box-shadow: 0 0 8px #333;"></div>
                    <span style="color: #888;">BLACK</span>
                    <span style="color: #aaa;">= Gnostic</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 40px; height: 4px; background: #FFD700; border-radius: 2px; box-shadow: 0 0 8px #FFD700;"></div>
                    <span style="color: #FFD700;">GOLD</span>
                    <span style="color: #aaa;">= Lost/Referenced Books</span>
                </div>
            </div>

            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(147, 112, 219, 0.2); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #9370DB;">
                    <div id="inline-deutero-count" style="font-size: 2em; font-weight: bold; color: #9370DB;">0</div>
                    <div style="color: #aaa;">Deuterocanonical</div>
                </div>
                <div style="background: rgba(255, 107, 157, 0.2); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ff6b9d;">
                    <div id="inline-ethiopian-count" style="font-size: 2em; font-weight: bold; color: #ff6b9d;">0</div>
                    <div style="color: #aaa;">Ethiopian</div>
                </div>
                <div style="background: rgba(136, 136, 136, 0.2); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #888;">
                    <div id="inline-gnostic-count" style="font-size: 2em; font-weight: bold; color: #888;">0</div>
                    <div style="color: #aaa;">Gnostic</div>
                </div>
                <div style="background: rgba(255, 165, 0, 0.2); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ffa500;">
                    <div id="inline-lost-count" style="font-size: 2em; font-weight: bold; color: #ffa500;">0</div>
                    <div style="color: #aaa;">Lost Text</div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="inline-tab-btn active" onclick="filterInlineTable('all')" id="inline-tab-all"
                    style="padding: 8px 16px; background: #FF0000; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">All</button>
                <button class="inline-tab-btn" onclick="filterInlineTable('Deuterocanonical')" id="inline-tab-deutero"
                    style="padding: 8px 16px; background: rgba(147, 112, 219, 0.3); color: #9370DB; border: 1px solid #9370DB; border-radius: 4px; cursor: pointer;">Deuterocanonical</button>
                <button class="inline-tab-btn" onclick="filterInlineTable('Ethiopian')" id="inline-tab-ethiopian"
                    style="padding: 8px 16px; background: rgba(255, 107, 157, 0.3); color: #ff6b9d; border: 1px solid #ff6b9d; border-radius: 4px; cursor: pointer;">Ethiopian</button>
                <button class="inline-tab-btn" onclick="filterInlineTable('Gnostic')" id="inline-tab-gnostic"
                    style="padding: 8px 16px; background: rgba(136, 136, 136, 0.3); color: #888; border: 1px solid #888; border-radius: 4px; cursor: pointer;">Gnostic</button>
                <button class="inline-tab-btn" onclick="filterInlineTable('Lost')" id="inline-tab-lost"
                    style="padding: 8px 16px; background: rgba(255, 165, 0, 0.3); color: #ffa500; border: 1px solid #ffa500; border-radius: 4px; cursor: pointer;">Lost</button>
            </div>

            <!-- Cross-Reference Table -->
            <div style="max-height: 600px; overflow-y: auto; border: 1px solid rgba(255, 0, 0, 0.3); border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: #1a1a2e; z-index: 1;">
                        <tr>
                            <th onclick="sortInlineTable('nt')" style="padding: 12px; text-align: left; color: var(--accent-gold); border-bottom: 2px solid #FF0000; width: 25%; cursor: pointer; user-select: none;" title="Click to sort">From (Canonical) <span id="sort-nt" style="opacity: 0.5;">‚Üï</span></th>
                            <th onclick="sortInlineTable('target')" style="padding: 12px; text-align: left; color: var(--accent-gold); border-bottom: 2px solid #FF0000; width: 25%; cursor: pointer; user-select: none;" title="Click to sort">To (Non-Canon) <span id="sort-target" style="opacity: 0.5;">‚Üï</span></th>
                            <th onclick="sortInlineTable('type')" style="padding: 12px; text-align: center; color: var(--accent-gold); border-bottom: 2px solid #FF0000; width: 12%; cursor: pointer; user-select: none;" title="Click to sort">Type <span id="sort-type" style="opacity: 0.5;">‚Üï</span></th>
                            <th onclick="sortInlineTable('votes')" style="padding: 12px; text-align: center; color: var(--accent-gold); border-bottom: 2px solid #FF0000; width: 8%; cursor: pointer; user-select: none;" title="Click to sort">Votes <span id="sort-votes" style="opacity: 0.5;">‚Üï</span></th>
                            <th onclick="sortInlineTable('desc')" style="padding: 12px; text-align: left; color: var(--accent-gold); border-bottom: 2px solid #FF0000; width: 30%; cursor: pointer; user-select: none;" title="Click to sort">Description <span id="sort-desc" style="opacity: 0.5;">‚Üï</span></th>
                        </tr>
                    </thead>
                    <tbody id="inline-table-body">
                        <tr><td colspan="5" style="padding: 20px; text-align: center; color: #888;">Loading cross-references...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Vote Legend -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(255, 0, 0, 0.1); border-left: 4px solid #FF0000; border-radius: 4px;">
                <strong>üìä Vote Legend:</strong>
                <ul style="margin: 10px 0; line-height: 1.8;">
                    <li><span style="color: var(--accent-gold);">100 votes</span> = High Confidence (Direct quotes or explicit citations)</li>
                    <li><span style="color: #ffa500;">50 votes</span> = Medium Confidence (Strong thematic or conceptual parallels)</li>
                    <li><span style="color: #ff6b6b;">25 votes</span> = Lower Confidence (Possible allusions or shared themes)</li>
                </ul>
                <p style="margin-top: 15px; color: var(--accent-cyan);"><strong>‚≠ê Featured:</strong> Jude 1:14-15 quotes 1 Enoch 1:9 - one of the most famous intertestamental quotations in the New Testament!</p>
            </div>
        </div>
    </div>

    <!-- Books Modal -->
    <div id="books-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeBooksModal()">&times;</span>
            <h2 style="color: var(--accent-gold); margin-top: 0;">üìö Complete 159-Book Biblical Library</h2>

            <div class="canon-section">
                <h3 style="color: #00CED1;">üîµ Protestant Canon (66 Books)</h3>
                <p style="color: #aaa; margin-bottom: 10px;">Standard Christian Bible - Old Testament (39) + New Testament (27)</p>
                <div class="books-grid" id="protestant-books"></div>
            </div>

            <div class="canon-section">
                <h3 style="color: #9370DB;">üü£ Deuterocanonical Books (14 Books)</h3>
                <p style="color: #aaa; margin-bottom: 10px;">Catholic/Orthodox additions - included in Septuagint</p>
                <div class="books-grid" id="deutero-books"></div>
            </div>

            <div class="canon-section">
                <h3 style="color: #ff6b9d;">üî¥ Ethiopian/Pseudepigrapha (21 Books)</h3>
                <p style="color: #aaa; margin-bottom: 10px;">Ethiopian Orthodox Tewahedo Church & ancient Jewish texts</p>
                <div class="books-grid" id="ethiopian-books"></div>
            </div>

            <div class="canon-section">
                <h3 style="color: #00BFFF;">üî∑ Dead Sea Scrolls (10 Books)</h3>
                <p style="color: #aaa; margin-bottom: 10px;">Qumran community texts discovered 1947-1956</p>
                <div class="books-grid" id="dss-books"></div>
            </div>

            <div class="canon-section">
                <h3 style="color: #888888;">‚ö´ Gnostic & Early Christian (22 Books)</h3>
                <p style="color: #aaa; margin-bottom: 10px;">Ancient texts rejected by mainstream Christianity</p>
                <div class="books-grid" id="gnostic-books"></div>
            </div>

            <div class="canon-section">
                <h3 style="color: #ffa500;">üìú Lost Books (26 Books)</h3>
                <p style="color: #aaa; margin-bottom: 10px;">Referenced in Scripture but lost to history</p>
                <div class="books-grid" id="lost-books"></div>
            </div>
        </div>
    </div>

    <!-- Text Viewer Modal -->
    <div id="text-viewer-modal" class="text-viewer-modal">
        <div class="text-viewer-content">
            <div class="text-viewer-header">
                <h2 class="text-viewer-title" id="text-viewer-title">Book Title</h2>
                <button class="close-viewer-btn" onclick="closeTextViewer()">&times;</button>
            </div>
            <div class="chapter-nav">
                <button class="chapter-btn" id="prev-chapter-btn" onclick="prevChapter()">&#8592; Previous</button>
                <div class="chapter-selector">
                    <label>Chapter: </label>
                    <select id="chapter-select" onchange="goToChapter(this.value)"></select>
                </div>
                <button class="chapter-btn" id="next-chapter-btn" onclick="nextChapter()">Next &#8594;</button>
            </div>
            <div class="text-viewer-body" id="text-viewer-body">
                Loading...
            </div>
        </div>
    </div>

    <!-- Non-Canon Cross-References Modal -->
    <div id="noncanon-modal" class="modal">
        <div class="modal-content" style="max-width: 1100px;">
            <span class="modal-close" onclick="closeNonCanonModal()">&times;</span>
            <h2 style="color: #FF0000; margin-top: 0;">üî¥ Non-Canonical Cross-References</h2>
            <p style="color: #ccc; margin-bottom: 15px;">These cross-references connect canonical Scripture to non-canonical texts.</p>
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <span><strong style="color: #FF0000;">üî¥ RED</strong> = Deuterocanonical</span>
                <span><strong style="color: #ff6b9d;">ü©∑ PINK</strong> = Ethiopian</span>
                <span><strong style="color: #888;">‚ö´ BLACK</strong> = Gnostic</span>
                <span><strong style="color: #FFD700;">üü° GOLD</strong> = Lost Books</span>
            </div>

            <div class="noncanon-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                <div style="background: rgba(147, 112, 219, 0.2); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #9370DB;">
                    <div id="modal-deutero-count" style="font-size: 2em; font-weight: bold; color: #9370DB;">0</div>
                    <div style="color: #aaa;">Deuterocanonical</div>
                </div>
                <div style="background: rgba(255, 107, 157, 0.2); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ff6b9d;">
                    <div id="modal-ethiopian-count" style="font-size: 2em; font-weight: bold; color: #ff6b9d;">0</div>
                    <div style="color: #aaa;">Ethiopian</div>
                </div>
                <div style="background: rgba(136, 136, 136, 0.2); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #888;">
                    <div id="modal-gnostic-count" style="font-size: 2em; font-weight: bold; color: #888;">0</div>
                    <div style="color: #aaa;">Gnostic</div>
                </div>
                <div style="background: rgba(255, 165, 0, 0.2); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ffa500;">
                    <div id="modal-lost-count" style="font-size: 2em; font-weight: bold; color: #ffa500;">0</div>
                    <div style="color: #aaa;">Lost Text</div>
                </div>
            </div>

            <div class="noncanon-tabs" style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="tab-btn active" onclick="showNonCanonTab('all')" id="tab-all">All</button>
                <button class="tab-btn" onclick="showNonCanonTab('Deuterocanonical')" id="tab-deutero">Deuterocanonical</button>
                <button class="tab-btn" onclick="showNonCanonTab('Ethiopian')" id="tab-ethiopian">Ethiopian</button>
                <button class="tab-btn" onclick="showNonCanonTab('Gnostic')" id="tab-gnostic">Gnostic</button>
                <button class="tab-btn" onclick="showNonCanonTab('Lost')" id="tab-lost">Lost</button>
            </div>

            <div style="max-height: 400px; overflow-y: auto; border: 1px solid rgba(255, 0, 0, 0.3); border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: #1a1a2e;">
                        <tr>
                            <th style="padding: 12px; text-align: left; color: var(--accent-gold); border-bottom: 2px solid #FF0000;">From (Canonical)</th>
                            <th style="padding: 12px; text-align: left; color: var(--accent-gold); border-bottom: 2px solid #FF0000;">To (Non-Canon)</th>
                            <th style="padding: 12px; text-align: center; color: var(--accent-gold); border-bottom: 2px solid #FF0000;">Type</th>
                            <th style="padding: 12px; text-align: center; color: var(--accent-gold); border-bottom: 2px solid #FF0000;">Votes</th>
                        </tr>
                    </thead>
                    <tbody id="noncanon-table-body">
                        <tr><td colspan="4" style="padding: 20px; text-align: center; color: #888;">Loading cross-references...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p id="loading-message">Loading Bible data...</p>
        <div class="loading-bar">
            <div id="loading-progress" class="loading-bar-fill"></div>
        </div>
    </div>

    <!-- D3.js -->
    <script src="lib/d3.v7.min.js"></script>

    <!-- Data loaders -->
    <script src="js/data-augmenter-147.js"></script>
    <script src="js/data-loader.js"></script>
    <script src="js/theographic-loader.js"></script>
    <script src="js/cross-ref-loader.js"></script>

    <!-- Visualization -->
    <script src="js/arc-diagram-tableau-style.js"></script>

    <!-- Initialization -->
    <script>
        // Global instances are already created in data-loader.js and theographic-loader.js
        // dataLoader and theographicLoader are available globally
        let arcDiagram = null;

        // Initialize
        async function init() {
            try {
                console.log('üîç Initializing 159-Book Biblical Visualizer...');

                showLoading('Loading 159-book cross-reference data...');

                // Setup progress tracking
                dataLoader.onProgress((percent, message) => {
                    updateLoadingProgress(percent, message);
                });

                // Load data
                await dataLoader.load();
                console.log('‚úÖ Data loaded successfully');

                // Load non-canonical cross-references (for stats and red arcs)
                updateLoadingProgress(90, 'Loading non-canonical cross-references...');
                const nonCanonData = await loadNonCanonicalRefs();
                console.log(`‚úÖ Loaded ${nonCanonRefs.length} non-canonical cross-references`);

                hideLoading();

                // Initialize visualization with non-canon refs
                arcDiagram = new ArcDiagramTableauStyle('arc-svg', 'arc-tooltip');
                arcDiagram.setNonCanonicalRefs(nonCanonRefs);
                arcDiagram.render();

                // Populate the inline non-canonical section
                populateInlineSection();

                // Setup controls
                setupControls();

                console.log('‚úÖ Visualization ready!');
            } catch (error) {
                console.error('‚ùå Error initializing:', error);
                hideLoading();
                alert('Error loading data: ' + error.message);
            }
        }

        function setupControls() {
            // Testament filter
            document.getElementById('testament-filter').addEventListener('change', (e) => {
                if (arcDiagram) {
                    arcDiagram.render({ testament: e.target.value });
                }
            });

            // Min connections slider
            const minSlider = document.getElementById('min-connections');
            const minValue = document.getElementById('min-value');
            minSlider.addEventListener('input', (e) => {
                minValue.textContent = e.target.value;
                if (arcDiagram) {
                    arcDiagram.render({ minConnections: parseInt(e.target.value) });
                }
            });

            // Reset button
            document.getElementById('reset-btn').addEventListener('click', () => {
                document.getElementById('testament-filter').value = 'all';
                minSlider.value = 1;
                minValue.textContent = '1';
                if (arcDiagram) {
                    arcDiagram.render({ testament: 'all', minConnections: 1 });
                }
            });

            // Export SVG button
            document.getElementById('export-svg-btn').addEventListener('click', () => {
                const svgElement = document.getElementById('arc-svg');
                if (!svgElement) {
                    alert('No SVG to export');
                    return;
                }

                // Clone the SVG to add styles
                const svgClone = svgElement.cloneNode(true);

                // Add background color
                svgClone.style.backgroundColor = '#1a1a2e';

                // Serialize to string
                const serializer = new XMLSerializer();
                let svgString = serializer.serializeToString(svgClone);

                // Add XML declaration and DOCTYPE
                svgString = '<?xml version="1.0" encoding="UTF-8"?>\n' + svgString;

                // Create blob and download
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'bible-cross-references-159books.svg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });
        }

        function showLoading(message) {
            const overlay = document.getElementById('loading-overlay');
            const msgEl = document.getElementById('loading-message');
            if (overlay && msgEl) {
                msgEl.textContent = message;
                overlay.style.display = 'flex';
            }
        }

        function updateLoadingProgress(percent, message) {
            const progress = document.getElementById('loading-progress');
            const msgEl = document.getElementById('loading-message');
            if (progress && msgEl) {
                progress.style.width = percent + '%';
                msgEl.textContent = message;
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Books Modal - All 159 Books
        const booksData = {
            protestant: [
                // Old Testament (39 books)
                {name: 'Genesis', chapters: 50}, {name: 'Exodus', chapters: 40}, {name: 'Leviticus', chapters: 27}, {name: 'Numbers', chapters: 36}, {name: 'Deuteronomy', chapters: 34},
                {name: 'Joshua', chapters: 24}, {name: 'Judges', chapters: 21}, {name: 'Ruth', chapters: 4}, {name: '1 Samuel', chapters: 31}, {name: '2 Samuel', chapters: 24},
                {name: '1 Kings', chapters: 22}, {name: '2 Kings', chapters: 25}, {name: '1 Chronicles', chapters: 29}, {name: '2 Chronicles', chapters: 36}, {name: 'Ezra', chapters: 10},
                {name: 'Nehemiah', chapters: 13}, {name: 'Esther', chapters: 10}, {name: 'Job', chapters: 42}, {name: 'Psalms', chapters: 150}, {name: 'Proverbs', chapters: 31},
                {name: 'Ecclesiastes', chapters: 12}, {name: 'Song of Solomon', chapters: 8}, {name: 'Isaiah', chapters: 66}, {name: 'Jeremiah', chapters: 52}, {name: 'Lamentations', chapters: 5},
                {name: 'Ezekiel', chapters: 48}, {name: 'Daniel', chapters: 12}, {name: 'Hosea', chapters: 14}, {name: 'Joel', chapters: 3}, {name: 'Amos', chapters: 9},
                {name: 'Obadiah', chapters: 1}, {name: 'Jonah', chapters: 4}, {name: 'Micah', chapters: 7}, {name: 'Nahum', chapters: 3}, {name: 'Habakkuk', chapters: 3},
                {name: 'Zephaniah', chapters: 3}, {name: 'Haggai', chapters: 2}, {name: 'Zechariah', chapters: 14}, {name: 'Malachi', chapters: 4},
                // New Testament (27 books)
                {name: 'Matthew', chapters: 28}, {name: 'Mark', chapters: 16}, {name: 'Luke', chapters: 24}, {name: 'John', chapters: 21}, {name: 'Acts', chapters: 28},
                {name: 'Romans', chapters: 16}, {name: '1 Corinthians', chapters: 16}, {name: '2 Corinthians', chapters: 13}, {name: 'Galatians', chapters: 6}, {name: 'Ephesians', chapters: 6},
                {name: 'Philippians', chapters: 4}, {name: 'Colossians', chapters: 4}, {name: '1 Thessalonians', chapters: 5}, {name: '2 Thessalonians', chapters: 3}, {name: '1 Timothy', chapters: 6},
                {name: '2 Timothy', chapters: 4}, {name: 'Titus', chapters: 3}, {name: 'Philemon', chapters: 1}, {name: 'Hebrews', chapters: 13}, {name: 'James', chapters: 5},
                {name: '1 Peter', chapters: 5}, {name: '2 Peter', chapters: 3}, {name: '1 John', chapters: 5}, {name: '2 John', chapters: 1}, {name: '3 John', chapters: 1},
                {name: 'Jude', chapters: 1}, {name: 'Revelation', chapters: 22}
            ],
            deuterocanonical: [
                {name: 'Tobit', chapters: 14}, {name: 'Judith', chapters: 16}, {name: 'Wisdom', chapters: 19}, {name: 'Sirach', chapters: 51},
                {name: 'Baruch', chapters: 6}, {name: '1 Maccabees', chapters: 16}, {name: '2 Maccabees', chapters: 15}, {name: 'Susanna', chapters: 1},
                {name: 'Bel and the Dragon', chapters: 1}, {name: 'Prayer of Azariah', chapters: 1}, {name: 'Greek Esther', chapters: 6},
                {name: '1 Esdras', chapters: 9}, {name: '2 Esdras', chapters: 16}, {name: 'Prayer of Manasseh', chapters: 1}
            ],
            ethiopian: [
                {name: '1 Enoch', chapters: 108}, {name: '2 Enoch', chapters: 68}, {name: '3 Enoch', chapters: 48}, {name: 'Jubilees', chapters: 50},
                {name: '2 Baruch', chapters: 87}, {name: '3 Baruch', chapters: 17}, {name: '4 Baruch', chapters: 9},
                {name: '3 Maccabees', chapters: 7}, {name: '4 Maccabees', chapters: 18}, {name: 'Psalms of Solomon', chapters: 18},
                {name: '4 Ezra', chapters: 16}, {name: 'Life of Adam and Eve', chapters: 51}, {name: 'Book of Jasher', chapters: 91},
                {name: 'Testament of the Twelve Patriarchs', chapters: 12}, {name: 'Testament of Solomon', chapters: 26},
                {name: 'Martyrdom and Ascension of Isaiah', chapters: 11}, {name: 'Assumption of Moses', chapters: 12},
                {name: 'Testament of Abraham', chapters: 20}, {name: 'Testament of Job', chapters: 53},
                {name: 'Apocalypse of Abraham', chapters: 32}, {name: 'Apocalypse of Sedrach', chapters: 1}
            ],
            deadSeaScrolls: [
                {name: 'Community Rule (1QS)', chapters: 1}, {name: 'War Scroll (1QM)', chapters: 1}, {name: 'Temple Scroll (11QT)', chapters: 1},
                {name: 'Damascus Document (CD)', chapters: 1}, {name: 'Thanksgiving Hymns (1QH)', chapters: 1}, {name: 'Pesher Habakkuk', chapters: 1},
                {name: 'Book of Giants', chapters: 1}, {name: 'Copper Scroll (3Q15)', chapters: 1}, {name: 'Genesis Apocryphon', chapters: 1},
                {name: 'Songs of Sabbath Sacrifice', chapters: 1}
            ],
            gnostic: [
                {name: 'Gospel of Judas', chapters: 1}, {name: 'Gospel of Thomas', chapters: 1}, {name: 'Gospel of Mary', chapters: 1},
                {name: 'Gospel of Peter', chapters: 1}, {name: 'Gospel of Philip', chapters: 1}, {name: 'Gospel of the Hebrews', chapters: 1},
                {name: 'Gospel of the Egyptians', chapters: 1}, {name: 'Gospel of Truth', chapters: 1}, {name: 'Gospel of Nicodemus', chapters: 1},
                {name: 'Infancy Gospel of Thomas', chapters: 1}, {name: 'Protoevangelium of James', chapters: 1}, {name: 'Secret Gospel of Mark', chapters: 1},
                {name: 'Apocryphon of John', chapters: 1}, {name: 'Sophia of Jesus Christ', chapters: 1}, {name: 'Pistis Sophia', chapters: 4},
                {name: 'Dialogue of the Savior', chapters: 1}, {name: 'Book of Thomas the Contender', chapters: 1}, {name: 'Didache', chapters: 16},
                {name: 'Shepherd of Hermas', chapters: 114}, {name: 'Epistle of Barnabas', chapters: 21}, {name: 'Acts of Paul and Thecla', chapters: 1},
                {name: 'Apocalypse of Peter', chapters: 1}
            ],
            lost: [
                {name: 'Book of the Wars of the Lord', chapters: '?'}, {name: 'Book of Jasher (Lost)', chapters: '?'},
                {name: 'Annals of Solomon', chapters: '?'}, {name: 'Annals of King David', chapters: '?'},
                {name: 'Annals of Kings of Israel', chapters: '?'}, {name: 'Annals of Kings of Judah', chapters: '?'},
                {name: 'Book of Kings of Israel & Judah', chapters: '?'}, {name: 'Book of Samuel the Seer', chapters: '?'},
                {name: 'Book of Nathan the Prophet', chapters: '?'}, {name: 'Book of Gad the Seer', chapters: '?'},
                {name: 'Prophecy of Ahijah', chapters: '?'}, {name: 'Visions of Iddo the Seer', chapters: '?'},
                {name: 'Story of Prophet Iddo', chapters: '?'}, {name: 'Book of Shemaiah', chapters: '?'},
                {name: 'Book of Jehu', chapters: '?'}, {name: 'Sayings of the Seers', chapters: '?'},
                {name: 'Acts of Uzziah by Isaiah', chapters: '?'}, {name: 'Laments for Josiah', chapters: '?'},
                {name: 'Commentary on Book of Kings', chapters: '?'}, {name: 'Manner of the Kingdom', chapters: '?'},
                {name: 'Epistle to the Laodiceans', chapters: '?'}, {name: 'Earlier Epistle to Corinthians', chapters: '?'},
                {name: 'Severe Letter to Corinthians', chapters: '?'}, {name: 'Assumption of Moses', chapters: '?'},
                {name: 'Prayer of Manasseh (source)', chapters: '?'}, {name: 'Visions of Iddo (Jeroboam)', chapters: '?'}
            ]
        };

        function showBooksModal() {
            const modal = document.getElementById('books-modal');

            // Populate Protestant books (clickable)
            const protestantDiv = document.getElementById('protestant-books');
            protestantDiv.innerHTML = booksData.protestant.map(book =>
                `<div class="book-item protestant" onclick="openTextViewer('${book.name}', ${typeof book.chapters === 'number' ? book.chapters : 1})"><strong>${book.name}</strong><br/><small>${book.chapters} chapters - Click to read</small></div>`
            ).join('');

            // Populate Deuterocanonical books (clickable)
            const deuteroDiv = document.getElementById('deutero-books');
            deuteroDiv.innerHTML = booksData.deuterocanonical.map(book =>
                `<div class="book-item deuterocanonical" onclick="openTextViewer('${book.name}', ${typeof book.chapters === 'number' ? book.chapters : 1})"><strong>${book.name}</strong><br/><small>${book.chapters} chapters - Click to read</small></div>`
            ).join('');

            // Populate Ethiopian books (clickable)
            const ethiopianDiv = document.getElementById('ethiopian-books');
            ethiopianDiv.innerHTML = booksData.ethiopian.map(book =>
                `<div class="book-item ethiopian" onclick="openTextViewer('${book.name}', ${typeof book.chapters === 'number' ? book.chapters : 1})"><strong>${book.name}</strong><br/><small>${book.chapters} chapters - Click to read</small></div>`
            ).join('');

            // Populate Dead Sea Scrolls (clickable)
            const dssDiv = document.getElementById('dss-books');
            dssDiv.innerHTML = booksData.deadSeaScrolls.map(book =>
                `<div class="book-item dss" onclick="openTextViewer('${book.name}', ${typeof book.chapters === 'number' ? book.chapters : 1})"><strong>${book.name}</strong><br/><small>${book.chapters} chapters - Click to read</small></div>`
            ).join('');

            // Populate Gnostic books (clickable)
            const gnosticDiv = document.getElementById('gnostic-books');
            gnosticDiv.innerHTML = booksData.gnostic.map(book =>
                `<div class="book-item gnostic" onclick="openTextViewer('${book.name}', ${typeof book.chapters === 'number' ? book.chapters : 1})"><strong>${book.name}</strong><br/><small>${book.chapters} chapters - Click to read</small></div>`
            ).join('');

            // Populate Lost books (clickable - will show lost message)
            const lostDiv = document.getElementById('lost-books');
            lostDiv.innerHTML = booksData.lost.map(book =>
                `<div class="book-item lost" onclick="openTextViewer('${book.name}', 1)"><strong>${book.name}</strong><br/><small>Lost to history - Click for info</small></div>`
            ).join('');

            modal.style.display = 'block';
        }

        function closeBooksModal() {
            document.getElementById('books-modal').style.display = 'none';
        }

        // ========== TEXT VIEWER FUNCTIONS ==========

        // Book text sources configuration
        const bookTextSources = {
            // Gnostic Gospels - Local HTML Files
            'Gospel of Judas': { type: 'localHtml', file: 'gospel-of-judas.html', chapters: 1 },
            'Gospel of Thomas': { type: 'localHtml', file: 'gospel-of-thomas.html', chapters: 1 },
            'Gospel of Mary': { type: 'localHtml', file: 'gospel-of-mary.html', chapters: 1 },
            'Gospel of Peter': { type: 'localHtml', file: 'gospel-of-peter.html', chapters: 1 },
            'Gospel of Philip': { type: 'localHtml', file: 'gospel-of-philip.html', chapters: 1 },
            'Gospel of the Hebrews': { type: 'localHtml', file: 'gospel-of-hebrews.html', chapters: 1 },
            'Gospel of the Egyptians': { type: 'localHtml', file: 'gospel-of-egyptians.html', chapters: 1 },
            'Gospel of Truth': { type: 'localHtml', file: 'gospel-of-truth.html', chapters: 1 },
            'Gospel of Nicodemus': { type: 'localHtml', file: 'gospel-of-nicodemus.html', chapters: 1 },
            'Infancy Gospel of Thomas': { type: 'localHtml', file: 'infancy-gospel-thomas.html', chapters: 1 },
            'Protoevangelium of James': { type: 'localHtml', file: 'protoevangelium-james.html', chapters: 1 },
            'Secret Gospel of Mark': { type: 'localHtml', file: 'secret-gospel-mark.html', chapters: 1 },
            'Apocryphon of John': { type: 'localHtml', file: 'apocryphon-of-john.html', chapters: 1 },
            'Sophia of Jesus Christ': { type: 'localHtml', file: 'sophia-jesus-christ.html', chapters: 1 },
            'Pistis Sophia': { type: 'localHtml', file: 'pistis-sophia.html', chapters: 4 },
            'Dialogue of the Savior': { type: 'localHtml', file: 'dialogue-savior.html', chapters: 1 },
            'Book of Thomas the Contender': { type: 'localHtml', file: 'book-thomas-contender.html', chapters: 1 },
            'Didache': { type: 'localHtml', file: 'didache.html', chapters: 16 },
            'Shepherd of Hermas': { type: 'local', abbrev: 'Hermas', chapters: 114 },
            'Epistle of Barnabas': { type: 'localHtml', file: 'epistle-barnabas.html', chapters: 21 },
            'Acts of Paul and Thecla': { type: 'localHtml', file: 'acts-paul-thecla.html', chapters: 1 },
            'Apocalypse of Peter': { type: 'local', abbrev: 'ApocPet', chapters: 1 },

            // Ethiopian/Pseudepigrapha
            '1 Enoch': { type: 'local', abbrev: '1En', chapters: 108 },
            '2 Enoch': { type: 'local', abbrev: '2En', chapters: 68 },
            '3 Enoch': { type: 'local', abbrev: '3En', chapters: 48 },
            'Jubilees': { type: 'local', abbrev: 'Jub', chapters: 50 },
            '2 Baruch': { type: 'local', abbrev: '2Bar', chapters: 87 },
            '3 Baruch': { type: 'local', abbrev: '3Bar', chapters: 17 },
            '4 Baruch': { type: 'local', abbrev: '4Bar', chapters: 9 },
            'Assumption of Moses': { type: 'localHtml', file: 'assumption-moses.html', chapters: 12 },
            'Martyrdom and Ascension of Isaiah': { type: 'local', abbrev: 'AscIsa', chapters: 11 },
            'Life of Adam and Eve': { type: 'local', abbrev: 'LAE', chapters: 51 },
            'Testament of Abraham': { type: 'localHtml', file: 'testament-abraham.html', chapters: 20 },
            'Testament of Solomon': { type: 'local', abbrev: 'TSol', chapters: 26 },
            'Testament of Job': { type: 'localHtml', file: 'testament-job.html', chapters: 53 },
            'Apocalypse of Abraham': { type: 'localHtml', file: 'apocalypse-abraham.html', chapters: 32 },
            'Testament of the Twelve Patriarchs': { type: 'local', abbrev: 'T12Pat', chapters: 12 },
            '4 Ezra': { type: 'localHtml', file: '4-ezra.html', chapters: 16 },
            'Psalms of Solomon': { type: 'localHtml', file: 'psalms-solomon.html', chapters: 18 },
            '4 Maccabees': { type: 'localHtml', file: '4-maccabees.html', chapters: 18 },
            '3 Maccabees': { type: 'localHtml', file: '3-maccabees.html', chapters: 7 },
            'Book of Jasher': { type: 'local', abbrev: 'Jasher', chapters: 91 },
            'Apocalypse of Sedrach': { type: 'local', abbrev: 'Sedrach', chapters: 1 },

            // Deuterocanonical
            'Wisdom': { type: 'local', abbrev: 'Wis', chapters: 19 },
            'Sirach': { type: 'local', abbrev: 'Sir', chapters: 51 },
            'Tobit': { type: 'local', abbrev: 'Tob', chapters: 14 },
            'Judith': { type: 'local', abbrev: 'Jdt', chapters: 16 },
            'Baruch': { type: 'local', abbrev: 'Bar', chapters: 6 },
            '1 Maccabees': { type: 'local', abbrev: '1Macc', chapters: 16 },
            '2 Maccabees': { type: 'local', abbrev: '2Macc', chapters: 15 },
            'Susanna': { type: 'local', abbrev: 'Sus', chapters: 1 },
            'Bel and the Dragon': { type: 'local', abbrev: 'Bel', chapters: 1 },
            'Prayer of Azariah': { type: 'local', abbrev: 'PrAzar', chapters: 1 },
            'Greek Esther': { type: 'local', abbrev: 'GkEsth', chapters: 6 },
            '1 Esdras': { type: 'local', abbrev: '1Esd', chapters: 9 },
            '2 Esdras': { type: 'local', abbrev: '2Esd', chapters: 16 },
            'Prayer of Manasseh': { type: 'local', abbrev: 'PrMan', chapters: 1 },

            // Dead Sea Scrolls
            'Community Rule': { type: 'localHtml', file: 'dead-sea-scrolls/community-rule.html', chapters: 1 },
            'War Scroll': { type: 'localHtml', file: 'dead-sea-scrolls/war-scroll.html', chapters: 1 },
            'Temple Scroll': { type: 'localHtml', file: 'dead-sea-scrolls/temple-scroll.html', chapters: 1 },
            'Damascus Document': { type: 'localHtml', file: 'dead-sea-scrolls/damascus-document.html', chapters: 1 },
            'Thanksgiving Hymns': { type: 'localHtml', file: 'dead-sea-scrolls/thanksgiving-hymns.html', chapters: 1 },
            'Pesher Habakkuk': { type: 'localHtml', file: 'dead-sea-scrolls/pesher-habakkuk.html', chapters: 1 },
            'Book of Giants': { type: 'localHtml', file: 'dead-sea-scrolls/book-of-giants.html', chapters: 1 },
            'Copper Scroll': { type: 'localHtml', file: 'dead-sea-scrolls/copper-scroll.html', chapters: 1 },
            'Genesis Apocryphon': { type: 'localHtml', file: 'dead-sea-scrolls/genesis-apocryphon.html', chapters: 1 },
            'Songs of Sabbath Sacrifice': { type: 'localHtml', file: 'dead-sea-scrolls/songs-sabbath-sacrifice.html', chapters: 1 },

            // Lost Books descriptions
            'Book of the Wars of the Lord': { type: 'lost', description: 'Ancient Hebrew war chronicles cited in Numbers 21:14. Lost before the time of Christ.', references: ['Numbers 21:14'] },
            'Book of Jasher (Lost)': { type: 'lost', description: 'Ancient chronicle cited for the sun standing still and David\'s lament.', references: ['Joshua 10:13', '2 Samuel 1:18'] },
            'Book of the Annals of Solomon': { type: 'lost', description: 'Official court records of Solomon\'s reign.', references: ['1 Kings 11:41'] },
            'Annals of King David': { type: 'lost', description: 'Chronicles of King David\'s reign.', references: ['1 Chronicles 27:24'] },
            'Annals of Kings of Israel': { type: 'lost', description: 'Official court records of northern kingdom. Referenced 17 times.', references: ['1 Kings 14:19', '2 Kings 15:31'] },
            'Annals of Kings of Judah': { type: 'lost', description: 'Official court records of southern kingdom. Referenced 15 times.', references: ['1 Kings 14:29', '2 Kings 24:5'] },
            'Book of Kings of Israel & Judah': { type: 'lost', description: 'Combined chronicle of both kingdoms.', references: ['2 Chronicles 27:7', '2 Chronicles 35:27'] },
            'Book of Samuel the Seer': { type: 'lost', description: 'Prophetic records about David\'s reign.', references: ['1 Chronicles 29:29'] },
            'Book of Nathan the Prophet': { type: 'lost', description: 'Nathan\'s prophetic writings.', references: ['1 Chronicles 29:29', '2 Chronicles 9:29'] },
            'Book of Gad the Seer': { type: 'lost', description: 'Prophetic records by David\'s seer.', references: ['1 Chronicles 29:29'] },
            'Prophecy of Ahijah': { type: 'lost', description: 'Prophetic writings about Solomon and Jeroboam.', references: ['2 Chronicles 9:29'] },
            'Visions of Iddo the Seer': { type: 'lost', description: 'Prophetic visions referenced 3 times.', references: ['2 Chronicles 9:29', '2 Chronicles 12:15'] },
            'Story of Prophet Iddo': { type: 'lost', description: 'Midrash/story concerning prophet Iddo.', references: ['2 Chronicles 13:22'] },
            'Book of Shemaiah': { type: 'lost', description: 'Prophetic records about Rehoboam.', references: ['2 Chronicles 12:15'] },
            'Book of Jehu': { type: 'lost', description: 'Historical work about Jehoshaphat.', references: ['2 Chronicles 20:34'] },
            'Sayings of the Seers': { type: 'lost', description: 'Collection of prophetic sayings.', references: ['2 Chronicles 33:19'] },
            'Acts of Uzziah by Isaiah': { type: 'lost', description: 'Isaiah\'s record of King Uzziah.', references: ['2 Chronicles 26:22'] },
            'Laments for Josiah': { type: 'lost', description: 'Jeremiah\'s laments for King Josiah.', references: ['2 Chronicles 35:25'] },
            'Commentary on Book of Kings': { type: 'lost', description: 'Midrash on the Book of Kings.', references: ['2 Chronicles 24:27'] },
            'Manner of the Kingdom': { type: 'lost', description: 'Samuel\'s book on kingly governance.', references: ['1 Samuel 10:25'] },
            'Epistle to the Laodiceans': { type: 'lost', description: 'Paul\'s letter mentioned in Colossians 4:16.', references: ['Colossians 4:16'] },
            'Earlier Epistle to Corinthians': { type: 'lost', description: 'Paul\'s first letter to Corinth (before canonical 1 Corinthians).', references: ['1 Corinthians 5:9'] },
            'Severe Letter to Corinthians': { type: 'lost', description: 'Paul\'s tearful/severe letter written between 1 and 2 Corinthians.', references: ['2 Corinthians 2:4', '2 Corinthians 7:8'] },
            'Assumption of Moses (Lost)': { type: 'lost', description: 'Source for Michael vs Satan dispute over Moses\' body.', references: ['Jude 9'] },
            'Prayer of Manasseh (source)': { type: 'lost', description: 'Original source referenced for Manasseh\'s prayer.', references: ['2 Chronicles 33:18'] },
            'Visions of Iddo (Jeroboam)': { type: 'lost', description: 'Iddo\'s visions specifically about Jeroboam.', references: ['2 Chronicles 9:29'] }
        };

        // Text viewer state
        let currentViewerBook = null;
        let currentViewerChapter = 1;
        let currentViewerTotalChapters = 1;

        function openTextViewer(bookName, chapters) {
            currentViewerBook = bookName;
            currentViewerChapter = 1;
            currentViewerTotalChapters = chapters || 1;

            document.getElementById('text-viewer-title').textContent = bookName;
            document.getElementById('text-viewer-modal').style.display = 'block';
            populateChapterSelector();
            loadViewerContent();
        }

        function closeTextViewer() {
            document.getElementById('text-viewer-modal').style.display = 'none';
        }

        function populateChapterSelector() {
            const select = document.getElementById('chapter-select');
            select.innerHTML = '';
            for (let i = 1; i <= currentViewerTotalChapters; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentViewerChapter) option.selected = true;
                select.appendChild(option);
            }
            updateChapterButtons();
        }

        function updateChapterButtons() {
            document.getElementById('prev-chapter-btn').disabled = currentViewerChapter <= 1;
            document.getElementById('next-chapter-btn').disabled = currentViewerChapter >= currentViewerTotalChapters;
        }

        function prevChapter() {
            if (currentViewerChapter > 1) {
                currentViewerChapter--;
                document.getElementById('chapter-select').value = currentViewerChapter;
                updateChapterButtons();
                loadViewerContent();
            }
        }

        function nextChapter() {
            if (currentViewerChapter < currentViewerTotalChapters) {
                currentViewerChapter++;
                document.getElementById('chapter-select').value = currentViewerChapter;
                updateChapterButtons();
                loadViewerContent();
            }
        }

        function goToChapter(chapter) {
            currentViewerChapter = parseInt(chapter);
            updateChapterButtons();
            loadViewerContent();
        }

        async function loadViewerContent() {
            const bookInfo = bookTextSources[currentViewerBook];
            const bodyDiv = document.getElementById('text-viewer-body');

            // Show/hide navigation based on chapters
            const showNav = currentViewerTotalChapters > 1;
            document.getElementById('prev-chapter-btn').style.display = showNav ? '' : 'none';
            document.getElementById('next-chapter-btn').style.display = showNav ? '' : 'none';
            document.querySelector('.chapter-selector').style.display = showNav ? '' : 'none';

            if (!bookInfo) {
                // Try to load from KJV for canonical books
                loadCanonicalBookContent();
                return;
            }

            if (bookInfo.type === 'lost') {
                // Show lost book info
                bodyDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #ffa500;">üìú Lost to History</h3>
                        <p style="color: #ccc; font-size: 1.1em; margin: 20px 0;">${bookInfo.description}</p>
                        ${bookInfo.references ? `
                            <div style="margin-top: 30px;">
                                <h4 style="color: var(--accent-gold);">Biblical References:</h4>
                                <ul style="list-style: none; padding: 0;">
                                    ${bookInfo.references.map(ref => `<li style="color: #00CED1; margin: 5px 0;">${ref}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <p style="color: #888; margin-top: 30px; font-style: italic;">This ancient text is mentioned in Scripture but no copies have survived to the present day.</p>
                    </div>
                `;
                return;
            }

            if (bookInfo.type === 'localHtml') {
                bodyDiv.innerHTML = '<p style="text-align:center;">Loading text...</p>';
                try {
                    const response = await fetch(`data/gnostic/${bookInfo.file}`);
                    if (response.ok) {
                        const html = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const content = doc.querySelector('.content, .text-content, article, main, body');
                        bodyDiv.innerHTML = content ? content.innerHTML : html;
                    } else {
                        bodyDiv.innerHTML = `<p style="text-align:center; color: #ff6b9d;">Text file not found. Visit the <a href="library.html?book=${encodeURIComponent(currentViewerBook)}" style="color: var(--accent-gold);">Library</a> for more options.</p>`;
                    }
                } catch (e) {
                    bodyDiv.innerHTML = `<p style="text-align:center; color: #ff6b9d;">Unable to load text. Visit the <a href="library.html?book=${encodeURIComponent(currentViewerBook)}" style="color: var(--accent-gold);">Library</a> for more options.</p>`;
                }
                return;
            }

            // For 'local' type or others, try to load from KJV or show not available
            loadCanonicalBookContent();
        }

        async function loadCanonicalBookContent() {
            const bodyDiv = document.getElementById('text-viewer-body');
            bodyDiv.innerHTML = '<p style="text-align:center;">Loading chapter...</p>';

            try {
                if (typeof BibleTextLoader !== 'undefined') {
                    const loader = new BibleTextLoader();
                    await loader.load();
                    const chapter = loader.getChapter(currentViewerBook, currentViewerChapter);
                    if (chapter && chapter.verses) {
                        bodyDiv.innerHTML = chapter.verses.map(v =>
                            `<div class="verse"><span class="verse-num">${v.verse}</span>${v.text}</div>`
                        ).join('');
                        return;
                    }
                }
                bodyDiv.innerHTML = `
                    <p style="text-align:center; color: #ccc;">
                        Text not available in this viewer.<br/>
                        <a href="library.html?book=${encodeURIComponent(currentViewerBook)}" style="color: var(--accent-gold);">Open in Library</a> for full reading experience.
                    </p>
                `;
            } catch (e) {
                bodyDiv.innerHTML = `<p style="text-align:center; color: #ff6b9d;">Unable to load text.</p>`;
            }
        }

        // Non-Canonical Cross-References
        let crossRefLoader = new CrossRefLoader();
        let nonCanonRefs = [];
        let currentFilter = 'all';
        let bibleText = null;

        // Abbreviation to full book name mapping for KJV lookup
        const bookAbbrevToFull = {
            'Gen': 'Genesis', 'Exod': 'Exodus', 'Lev': 'Leviticus', 'Num': 'Numbers', 'Deut': 'Deuteronomy',
            'Josh': 'Joshua', 'Judg': 'Judges', 'Ruth': 'Ruth', '1Sam': '1 Samuel', '2Sam': '2 Samuel',
            '1Kgs': '1 Kings', '2Kgs': '2 Kings', '1Chr': '1 Chronicles', '2Chr': '2 Chronicles',
            'Ezra': 'Ezra', 'Neh': 'Nehemiah', 'Esth': 'Esther', 'Job': 'Job', 'Ps': 'Psalms',
            'Prov': 'Proverbs', 'Eccl': 'Ecclesiastes', 'Song': 'Song of Solomon', 'Isa': 'Isaiah',
            'Jer': 'Jeremiah', 'Lam': 'Lamentations', 'Ezek': 'Ezekiel', 'Dan': 'Daniel',
            'Hos': 'Hosea', 'Joel': 'Joel', 'Amos': 'Amos', 'Obad': 'Obadiah', 'Jonah': 'Jonah',
            'Mic': 'Micah', 'Nah': 'Nahum', 'Hab': 'Habakkuk', 'Zeph': 'Zephaniah', 'Hag': 'Haggai',
            'Zech': 'Zechariah', 'Mal': 'Malachi',
            'Matt': 'Matthew', 'Mark': 'Mark', 'Luke': 'Luke', 'John': 'John', 'Acts': 'Acts',
            'Rom': 'Romans', '1Cor': '1 Corinthians', '2Cor': '2 Corinthians', 'Gal': 'Galatians',
            'Eph': 'Ephesians', 'Phil': 'Philippians', 'Col': 'Colossians', '1Thess': '1 Thessalonians',
            '2Thess': '2 Thessalonians', '1Tim': '1 Timothy', '2Tim': '2 Timothy', 'Titus': 'Titus',
            'Phlm': 'Philemon', 'Heb': 'Hebrews', 'Jas': 'James', '1Pet': '1 Peter', '2Pet': '2 Peter',
            '1John': '1 John', '2John': '2 John', '3John': '3 John', 'Jude': 'Jude', 'Rev': 'Revelation'
        };

        // Notable non-canonical text excerpts (since we may not have full JSON for all)
        const nonCanonTextExcerpts = {
            // Ethiopian/1 Enoch
            '1En.1.9': 'And behold! He cometh with ten thousands of His holy ones to execute judgment upon all...',
            '1En.10.4': 'Bind Azazel hand and foot, and cast him into the darkness...',
            '1En.10.6': 'Bind them fast for seventy generations in the valleys of the earth, till the day of their judgment.',
            '1En.14.8': 'I beheld a lofty throne...and round about were Seraphim, Cherubim, and Ophanim.',
            '1En.15.6': 'You were holy, spiritual, living the eternal life, but you became unclean with women...',
            '1En.22.1': 'The spirits of the souls of the dead...are divided into separate compartments.',
            '1En.62.5': 'When they see that Son of Man sitting on the throne of his glory...',
            '1En.69.27': 'The sum of judgment was given unto the Son of Man...',
            // Deuterocanonical
            'Wis.2.18': 'For if the just man be the son of God, he will help him...',
            'Wis.9.1': 'O God of my fathers, and Lord of mercy, who hast made all things with thy word...',
            'Wis.13.1': 'Surely vain are all men by nature, who are ignorant of God...',
            'Wis.16.13': 'For thou hast power of life and death: thou leadest to the gates of hell...',
            'Sir.51.23': 'Draw near unto me, ye unlearned, and dwell in the house of learning.',
            'Sir.10.14': 'The Lord hath cast down the thrones of proud princes...',
            '2Macc.7.1': 'It came to pass also, that seven brethren with their mother were taken...',
            '2Macc.6.18': 'Eleazar, one of the principal scribes...was constrained to open his mouth and eat swine\'s flesh.',
            '4Macc.6.27': 'Be merciful unto thy people, and let our punishment be sufficient for them.',
            '1Macc.1.54': 'They set up the abomination of desolation upon the altar...',
            'Jdt.16.17': 'Woe to the nations that rise up against my kindred...',
            'Jdt.13.18': 'Blessed art thou, O daughter, by the most high God, above all the women upon the earth.',
            'Tob.4.15': 'Do that to no man which thou hatest.',
            'Bar.3.29': 'Who hath gone up into heaven, and taken her, and brought her down from the clouds?',
            // GNOSTIC TEXTS - Didache
            'Did.1.1': 'There are two ways, one of life and one of death, and there is a great difference between them.',
            'Did.1.7': 'Concerning baptism, baptize in the name of the Father, Son, and Holy Spirit in living water.',
            'Did.1.8': 'After this manner therefore pray ye: Our Father which art in heaven, hallowed be thy name...',
            'Did.1.9': 'Give not that which is holy unto the dogs, neither cast pearls before swine.',
            // Gospel of Thomas
            'GThom.1.3': 'The Kingdom is inside you and outside you. When you know yourselves, you will be known.',
            'GThom.1.16': 'I have come to cast fire upon the earth...I have come to cast divisions upon the earth.',
            'GThom.1.22': 'When you make the two one, the inside like the outside...then you will enter the Kingdom.',
            'GThom.1.32': 'A city built on a high mountain and fortified cannot fall, nor can it be hidden.',
            'GThom.1.76': 'The Kingdom of the Father is like a merchant who had a consignment of merchandise and found a pearl.',
            'GThom.1.114': 'Every woman who makes herself male will enter the Kingdom of Heaven.',
            // Gospel of Judas
            'GJud.1.1': 'Judas said to Jesus: I know who you are and where you have come from. You are from the immortal realm of Barbelo.',
            // Gospel of Mary
            'GMary.1.1': 'Peter said to Mary: Sister, we know that the Savior loved you more than other women.',
            // Gospel of Peter
            'GPet.1.1': 'And they brought two malefactors, and crucified the Lord between them. But he held his peace.',
            // Gospel of Philip
            'GPhil.1.1': 'The Lord loved Mary Magdalene more than all the disciples and kissed her often on her mouth.',
            // Infancy Gospel of Thomas
            'InfThom.1.1': 'I, Thomas the Israelite, tell you all the works of the childhood of our Lord Jesus Christ.',
            // Shepherd of Hermas
            'Hermas.1.1': 'The shepherd, the angel of repentance, said to me: I wish to show you what the Holy Spirit showed you.',
            // Epistle of Barnabas
            'Barn.1.1': 'The way of light is this: If anyone wishes to travel to the appointed place, let him be zealous in his works.',
            // Protoevangelium of James
            'ProtJas.1.1': 'Mary was brought up in the Temple of the Lord like a dove, receiving food from the hand of an angel.',
            // Gospel of Nicodemus
            'GNic.1.1': 'I, Nicodemus, have recorded the things done in Jerusalem after the crucifixion of Jesus.',
            // Acts of Paul and Thecla
            'ActsPT.1.1': 'Thecla listened to Paul\'s word concerning virginity and resurrection, and believed.',
            // Apocalypse of Peter
            'ApocPet.1.1': 'And the Lord showed me a very great region outside this world, exceedingly bright with light.',
            // Secret Gospel of Mark
            'SecMark.1.1': 'And they came to Bethany, and a certain woman whose brother had died was there.',
            // Gospel of the Hebrews
            'GHeb.1.1': 'The Holy Spirit, my Mother, took me by one of my hairs and carried me to the great mountain Tabor.',
            // Gospel of the Egyptians
            'GEgy.1.1': 'When Salome asked, "How long will death hold sway?" the Lord said, "As long as you women bear children."',
            // Gospel of Truth
            'GTruth.1.1': 'The gospel of truth is joy for those who have received grace from the Father of truth.',
            // Apocryphon of John
            'ApocJohn.1.1': 'The Monad is a monarchy with nothing above it. It is God and Father of everything.',
            // Sophia of Jesus Christ
            'SophJC.1.1': 'After he rose from the dead, his twelve disciples gathered on a mountain in Galilee.',
            // Pistis Sophia
            'PistSoph.1.1': 'It happened that after Jesus had risen from the dead, he spent eleven years speaking with his disciples.',
            // Dialogue of the Savior
            'DialSav.1.1': 'The Lord said to his disciples: Seek and you will find. But what you asked me then, I did not tell you.',
            // Book of Thomas
            'BkThom.1.1': 'The secret words that the Savior spoke to Judas Thomas, which I, Mathaias, wrote down.'
        };

        // Additional Gnostic and Lost cross-references (from table-view.html)
        function getAdditionalNonCanonRefs() {
            return [
                // GNOSTIC GOSPEL REFERENCES
                // Gospel of Judas
                {nt: "Matt.26.14", target: "GJud.1.1", type: "Gnostic", votes: 5, desc: "Judas as Hero vs Traitor"},
                {nt: "Matt.26.24", target: "GJud.1.1", type: "Gnostic", votes: 5, desc: "Betrayal Blessed vs Cursed"},
                {nt: "John.13.27", target: "GJud.1.1", type: "Gnostic", votes: 5, desc: "Divine Plan vs Satan"},
                {nt: "Luke.22.3", target: "GJud.1.1", type: "Gnostic", votes: 5, desc: "Spiritual Superior vs Satan-Possessed"},
                // Gospel of Thomas
                {nt: "Matt.5.14", target: "GThom.1.32", type: "Gnostic", votes: 75, desc: "City on Hill"},
                {nt: "Matt.13.44", target: "GThom.1.76", type: "Gnostic", votes: 80, desc: "Pearl/Treasure Parable"},
                {nt: "Luke.17.20", target: "GThom.1.3", type: "Gnostic", votes: 85, desc: "Kingdom Within"},
                {nt: "Matt.10.34", target: "GThom.1.16", type: "Gnostic", votes: 70, desc: "Not Peace but Division"},
                {nt: "Matt.19.12", target: "GThom.1.114", type: "Gnostic", votes: 10, desc: "Gnostic Interpretation"},
                {nt: "John.3.3", target: "GThom.1.22", type: "Gnostic", votes: 15, desc: "Gnostic Unity vs Rebirth"},
                // Gospel of Mary
                {nt: "John.20.1", target: "GMary.1.1", type: "Gnostic", votes: 30, desc: "Mary's Special Relationship"},
                {nt: "Luke.8.2", target: "GMary.1.1", type: "Gnostic", votes: 15, desc: "Chief Disciple"},
                {nt: "Matt.16.18", target: "GMary.1.1", type: "Gnostic", votes: 10, desc: "Peter's Authority Challenged"},
                {nt: "1Cor.14.34", target: "GMary.1.1", type: "Gnostic", votes: 5, desc: "Women Teaching"},
                // Gospel of Peter
                {nt: "Matt.27.45", target: "GPet.1.1", type: "Gnostic", votes: 20, desc: "Docetic vs Real Suffering"},
                {nt: "Matt.28.2", target: "GPet.1.1", type: "Gnostic", votes: 15, desc: "Fantastical Account"},
                {nt: "Mark.16.5", target: "GPet.1.1", type: "Gnostic", votes: 10, desc: "Talking Cross"},
                {nt: "John.19.38", target: "GPet.1.1", type: "Gnostic", votes: 25, desc: "Dramatic Burial"},
                // Gospel of Philip
                {nt: "John.3.29", target: "GPhil.1.1", type: "Gnostic", votes: 30, desc: "Sacramental Mysticism"},
                {nt: "John.13.23", target: "GPhil.1.1", type: "Gnostic", votes: 10, desc: "Mary as Beloved"},
                {nt: "Matt.28.9", target: "GPhil.1.1", type: "Gnostic", votes: 15, desc: "Sacred Marriage"},
                {nt: "1Cor.15.50", target: "GPhil.1.1", type: "Gnostic", votes: 20, desc: "Gnostic Sacraments"},
                // Infancy Gospel of Thomas
                {nt: "Luke.2.40", target: "InfThom.1.1", type: "Gnostic", votes: 10, desc: "Magical Child"},
                {nt: "Luke.2.52", target: "InfThom.1.1", type: "Gnostic", votes: 15, desc: "Child's Miracles"},
                {nt: "Mark.6.3", target: "InfThom.1.1", type: "Gnostic", votes: 15, desc: "Carpenter's Son"},
                // Shepherd of Hermas
                {nt: "Matt.19.9", target: "Hermas.1.1", type: "Gnostic", votes: 50, desc: "Divorce Teaching"},
                {nt: "Heb.6.4", target: "Hermas.1.1", type: "Gnostic", votes: 25, desc: "Second Repentance"},
                {nt: "Jas.1.27", target: "Hermas.1.1", type: "Gnostic", votes: 60, desc: "Care for Widows"},
                // Epistle of Barnabas
                {nt: "Matt.5.17", target: "Barn.1.1", type: "Gnostic", votes: 10, desc: "OT Allegory"},
                {nt: "Rom.4.11", target: "Barn.1.1", type: "Gnostic", votes: 45, desc: "Spiritual Circumcision"},
                {nt: "Heb.10.1", target: "Barn.1.1", type: "Gnostic", votes: 55, desc: "OT as Shadow"},
                // Protoevangelium of James
                {nt: "Matt.1.25", target: "ProtJas.1.1", type: "Gnostic", votes: 15, desc: "Perpetual Virgin"},
                {nt: "Matt.1.18", target: "ProtJas.1.1", type: "Gnostic", votes: 35, desc: "Mary's Backstory"},
                // Gospel of Nicodemus
                {nt: "Matt.27.19", target: "GNic.1.1", type: "Gnostic", votes: 25, desc: "Pilate's Wife Dream"},
                {nt: "John.19.38", target: "GNic.1.1", type: "Gnostic", votes: 35, desc: "Expanded Burial"},
                {nt: "1Pet.3.19", target: "GNic.1.1", type: "Gnostic", votes: 50, desc: "Harrowing of Hell"},
                {nt: "Eph.4.8", target: "GNic.1.1", type: "Gnostic", votes: 45, desc: "Led Captives Free"},
                // Didache
                {nt: "Matt.6.9", target: "Did.1.8", type: "Gnostic", votes: 90, desc: "Lord's Prayer"},
                {nt: "Matt.7.6", target: "Did.1.9", type: "Gnostic", votes: 85, desc: "Holy to Dogs"},
                {nt: "Matt.28.19", target: "Did.1.7", type: "Gnostic", votes: 80, desc: "Baptismal Formula"},
                {nt: "Acts.2.42", target: "Did.1.1", type: "Gnostic", votes: 75, desc: "Church Order"},
                {nt: "1Thess.5.22", target: "Did.1.1", type: "Gnostic", votes: 70, desc: "Two Ways Teaching"},
                // Acts of Paul and Thecla
                {nt: "1Cor.14.34", target: "ActsPT.1.1", type: "Gnostic", votes: 10, desc: "Women Preaching"},
                {nt: "1Tim.2.12", target: "ActsPT.1.1", type: "Gnostic", votes: 5, desc: "Female Teacher"},
                {nt: "Acts.16.1", target: "ActsPT.1.1", type: "Gnostic", votes: 25, desc: "Paul's Companion"},
                // Apocalypse of Peter
                {nt: "Matt.13.41", target: "ApocPet.1.1", type: "Gnostic", votes: 30, desc: "Graphic Hell"},
                {nt: "Luke.16.23", target: "ApocPet.1.1", type: "Gnostic", votes: 35, desc: "Hell Tour"},
                {nt: "Rev.21.1", target: "ApocPet.1.1", type: "Gnostic", votes: 40, desc: "Paradise Vision"},
                // Secret Gospel of Mark
                {nt: "Mark.10.46", target: "SecMark.1.1", type: "Gnostic", votes: 10, desc: "Secret Teaching"},
                {nt: "Mark.14.51", target: "SecMark.1.1", type: "Gnostic", votes: 5, desc: "Young Man in Linen"},
                // Gospel of the Hebrews
                {nt: "Matt.3.16", target: "GHeb.1.1", type: "Gnostic", votes: 40, desc: "Spirit Speaks"},
                {nt: "John.7.53", target: "GHeb.1.1", type: "Gnostic", votes: 55, desc: "Woman Accused"},
                {nt: "1Cor.15.7", target: "GHeb.1.1", type: "Gnostic", votes: 60, desc: "James Appearance"},
                // Gospel of the Egyptians
                {nt: "Matt.22.30", target: "GEgy.1.1", type: "Gnostic", votes: 15, desc: "Anti-Marriage"},
                {nt: "1Cor.7.1", target: "GEgy.1.1", type: "Gnostic", votes: 20, desc: "Celibacy Emphasis"},
                // Gospel of Truth
                {nt: "John.1.14", target: "GTruth.1.1", type: "Gnostic", votes: 25, desc: "Gnostic Philosophy"},
                {nt: "2Cor.5.17", target: "GTruth.1.1", type: "Gnostic", votes: 20, desc: "Enlightenment"},
                // Apocryphon of John
                {nt: "Gen.1.26", target: "ApocJohn.1.1", type: "Gnostic", votes: 5, desc: "Evil Creator"},
                {nt: "John.8.44", target: "ApocJohn.1.1", type: "Gnostic", votes: 5, desc: "Demiurge"},
                // Sophia of Jesus Christ
                {nt: "John.20.19", target: "SophJC.1.1", type: "Gnostic", votes: 25, desc: "Post-Resurrection Teaching"},
                // Pistis Sophia
                {nt: "John.16.12", target: "PistSoph.1.1", type: "Gnostic", votes: 15, desc: "Secret Teachings"},
                {nt: "Matt.13.11", target: "PistSoph.1.1", type: "Gnostic", votes: 20, desc: "Mysteries of Kingdom"},
                // Dialogue of the Savior
                {nt: "Matt.7.7", target: "DialSav.1.1", type: "Gnostic", votes: 45, desc: "Seek and Find"},
                {nt: "John.14.6", target: "DialSav.1.1", type: "Gnostic", votes: 30, desc: "Way to Father"},
                // Book of Thomas
                {nt: "John.11.16", target: "BkThom.1.1", type: "Gnostic", votes: 35, desc: "Thomas the Twin"},
                {nt: "Matt.10.28", target: "BkThom.1.1", type: "Gnostic", votes: 20, desc: "Fear Not Body"},

                // LOST/REFERENCED BOOKS
                {nt: "Josh.10.13", target: "JasherL.1.1", type: "Lost", votes: 100, desc: "Sun Stood Still - Book of Jasher"},
                {nt: "2Sam.1.18", target: "JasherL.1.1", type: "Lost", votes: 100, desc: "David's Lament - Book of Jasher"},
                {nt: "Num.21.14", target: "WarsLord.1.1", type: "Lost", votes: 100, desc: "Book of Wars of the Lord"},
                {nt: "1Kgs.11.41", target: "AnnSol.1.1", type: "Lost", votes: 100, desc: "Annals of Solomon"},
                {nt: "1Kgs.14.19", target: "AnnIsr.1.1", type: "Lost", votes: 100, desc: "Annals of Kings of Israel"},
                {nt: "1Kgs.14.29", target: "AnnJud.1.1", type: "Lost", votes: 100, desc: "Annals of Kings of Judah"},
                {nt: "1Chr.29.29", target: "SamSeer.1.1", type: "Lost", votes: 100, desc: "Book of Samuel the Seer"},
                {nt: "2Chr.9.29", target: "Nathan.1.1", type: "Lost", votes: 100, desc: "Book of Nathan the Prophet"},
                {nt: "1Chr.29.29", target: "GadSeer.1.1", type: "Lost", votes: 100, desc: "Book of Gad the Seer"},
                {nt: "2Chr.9.29", target: "Ahijah.1.1", type: "Lost", votes: 100, desc: "Prophecy of Ahijah"},
                {nt: "2Chr.12.15", target: "Iddo.1.1", type: "Lost", votes: 100, desc: "Visions of Iddo the Seer"},
                {nt: "2Chr.12.15", target: "Shemaiah.1.1", type: "Lost", votes: 100, desc: "Book of Shemaiah"},
                {nt: "2Chr.20.34", target: "Jehu.1.1", type: "Lost", votes: 100, desc: "Book of Jehu"},
                {nt: "2Chr.33.19", target: "SaySeers.1.1", type: "Lost", votes: 100, desc: "Sayings of the Seers"},
                {nt: "Col.4.16", target: "EpLaod.1.1", type: "Lost", votes: 100, desc: "Epistle to the Laodiceans"},
                {nt: "1Cor.5.9", target: "EarlierCor.1.1", type: "Lost", votes: 100, desc: "Earlier Epistle to Corinthians"},
                {nt: "2Cor.2.4", target: "SevereCor.1.1", type: "Lost", votes: 100, desc: "Severe/Tearful Letter to Corinthians"},
                {nt: "1Chr.27.24", target: "AnnDavid.1.1", type: "Lost", votes: 100, desc: "Annals of King David"},
                {nt: "1Sam.10.25", target: "MannerKing.1.1", type: "Lost", votes: 100, desc: "Manner of the Kingdom (Book of Statutes)"},
                {nt: "2Chr.26.22", target: "ActsUzziah.1.1", type: "Lost", votes: 100, desc: "Acts of Uzziah by Isaiah"},
                {nt: "2Chr.35.25", target: "LamentsJos.1.1", type: "Lost", votes: 100, desc: "Laments for Josiah"},
                {nt: "2Chr.13.22", target: "StoryIddo.1.1", type: "Lost", votes: 100, desc: "Story/Midrash of Prophet Iddo"},
                {nt: "2Chr.27.7", target: "BkKingsIJ.1.1", type: "Lost", votes: 100, desc: "Book of Kings of Israel and Judah"},
                {nt: "2Chr.24.27", target: "CommKings.1.1", type: "Lost", votes: 100, desc: "Commentary on the Book of Kings"},
                {nt: "Jude.1.9", target: "AssumpMos.1.1", type: "Lost", votes: 100, desc: "Assumption of Moses - Michael vs Satan over body"},
                {nt: "2Chr.33.18", target: "PrayerMan.1.1", type: "Lost", votes: 75, desc: "Prayer of Manasseh (referenced source)"},
                {nt: "2Chr.9.29", target: "VisIddo.1.1", type: "Lost", votes: 100, desc: "Visions of Iddo concerning Jeroboam"}
            ];
        }

        // Load Bible text for verse lookups
        async function loadBibleText() {
            try {
                const response = await fetch('../data/bible-text/bible-kjv-converted.json');
                bibleText = await response.json();
                console.log('‚úÖ Bible text loaded for verse lookups');
                return bibleText;
            } catch (error) {
                console.error('Could not load Bible text:', error);
                return null;
            }
        }

        // Convert "Matt.11.28-30" to "Matthew 11:28" for KJV lookup
        function convertRefToKJVKey(ref) {
            if (!ref) return null;
            const parts = ref.split('.');
            if (parts.length < 3) return null;
            const bookAbbrev = parts[0];
            const chapter = parts[1];
            const verse = parts[2].split('-')[0]; // Take first verse if range
            const fullBook = bookAbbrevToFull[bookAbbrev];
            if (!fullBook) return null;
            return `${fullBook} ${chapter}:${verse}`;
        }

        // Get verse text from KJV or non-canonical excerpts
        function getVerseText(ref, isNonCanon = false) {
            if (!ref) return '';

            // Try non-canonical excerpts first for non-canon refs
            if (isNonCanon) {
                // Direct match first
                if (nonCanonTextExcerpts[ref]) {
                    return nonCanonTextExcerpts[ref];
                }

                // Try without verse (just book.chapter)
                const parts = ref.split('.');
                if (parts.length >= 2) {
                    const bookChapter = parts[0] + '.' + parts[1];
                    // Look for any key that starts with this book.chapter
                    for (const key of Object.keys(nonCanonTextExcerpts)) {
                        if (key.startsWith(bookChapter + '.') || key === bookChapter) {
                            return nonCanonTextExcerpts[key];
                        }
                    }
                    // Also try book.1 as fallback (many Gnostic refs use chapter 1)
                    const bookOnly = parts[0] + '.1.1';
                    if (nonCanonTextExcerpts[bookOnly]) {
                        return nonCanonTextExcerpts[bookOnly];
                    }
                }
            }

            // Try KJV for canonical refs
            if (bibleText) {
                const kjvKey = convertRefToKJVKey(ref);
                if (kjvKey && bibleText[kjvKey]) {
                    let text = bibleText[kjvKey];
                    // Clean up formatting markers
                    text = text.replace(/^#\s*/, '').replace(/\[([^\]]+)\]/g, '$1');
                    // Truncate if too long
                    if (text.length > 150) {
                        text = text.substring(0, 150) + '...';
                    }
                    return text;
                }
            }
            return '';
        }

        // Enrich references with verse text
        function enrichRefsWithText(refs) {
            refs.forEach(ref => {
                ref.ntText = getVerseText(ref.nt, false);
                ref.targetText = getVerseText(ref.target, true);
            });
        }

        async function loadNonCanonicalRefs() {
            try {
                console.log('Loading non-canonical cross-references...');

                // Load Bible text first
                await loadBibleText();

                await crossRefLoader.load();

                // Filter non-canonical references from file
                nonCanonRefs = crossRefLoader.allReferences.filter(ref =>
                    ref.type !== 'Canonical'
                );

                // Add additional Gnostic and Lost references
                const additionalRefs = getAdditionalNonCanonRefs();
                nonCanonRefs = [...nonCanonRefs, ...additionalRefs];
                console.log(`‚úÖ Added ${additionalRefs.length} additional Gnostic/Lost references`);

                // Enrich with verse text
                enrichRefsWithText(nonCanonRefs);
                console.log('‚úÖ Enriched refs with verse text');

                // Get stats
                const stats = {
                    deutero: nonCanonRefs.filter(r => r.type === 'Deuterocanonical').length,
                    ethiopian: nonCanonRefs.filter(r => r.type === 'Ethiopian').length,
                    gnostic: nonCanonRefs.filter(r => r.type === 'Gnostic').length,
                    lost: nonCanonRefs.filter(r => r.type === 'Lost').length
                };

                const total = stats.deutero + stats.ethiopian + stats.gnostic + stats.lost;

                // Update stat card
                document.getElementById('noncanon-count').textContent = total;
                document.getElementById('notable-count').textContent = total;

                console.log(`Loaded ${total} non-canonical cross-references:`, stats);

                return { refs: nonCanonRefs, stats };
            } catch (error) {
                console.error('Error loading cross-refs:', error);
                document.getElementById('noncanon-count').textContent = '0';
                return { refs: [], stats: { deutero: 0, ethiopian: 0, gnostic: 0, lost: 0 } };
            }
        }

        function showNonCanonModal() {
            const modal = document.getElementById('noncanon-modal');

            // Update counts in modal
            const stats = {
                deutero: nonCanonRefs.filter(r => r.type === 'Deuterocanonical').length,
                ethiopian: nonCanonRefs.filter(r => r.type === 'Ethiopian').length,
                gnostic: nonCanonRefs.filter(r => r.type === 'Gnostic').length,
                lost: nonCanonRefs.filter(r => r.type === 'Lost').length
            };

            document.getElementById('modal-deutero-count').textContent = stats.deutero;
            document.getElementById('modal-ethiopian-count').textContent = stats.ethiopian;
            document.getElementById('modal-gnostic-count').textContent = stats.gnostic;
            document.getElementById('modal-lost-count').textContent = stats.lost;

            // Populate table
            populateNonCanonTable('all');

            modal.style.display = 'block';
        }

        function closeNonCanonModal() {
            document.getElementById('noncanon-modal').style.display = 'none';
        }

        function showNonCanonTab(type) {
            currentFilter = type;

            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (type === 'all') {
                document.getElementById('tab-all').classList.add('active');
            } else if (type === 'Deuterocanonical') {
                document.getElementById('tab-deutero').classList.add('active');
            } else if (type === 'Ethiopian') {
                document.getElementById('tab-ethiopian').classList.add('active');
            } else if (type === 'Gnostic') {
                document.getElementById('tab-gnostic').classList.add('active');
            } else if (type === 'Lost') {
                document.getElementById('tab-lost').classList.add('active');
            }

            populateNonCanonTable(type);
        }

        function populateNonCanonTable(type) {
            const tbody = document.getElementById('noncanon-table-body');

            // Filter refs
            const filtered = type === 'all'
                ? nonCanonRefs
                : nonCanonRefs.filter(r => r.type === type);

            // Sort by votes (highest first)
            filtered.sort((a, b) => b.votes - a.votes);

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #888;">No cross-references found</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(ref => `
                <tr class="noncanon-row">
                    <td style="color: #00CED1;">${ref.nt}</td>
                    <td style="color: #FF6B6B;">${ref.target}</td>
                    <td style="text-align: center;"><span class="type-badge ${ref.type}">${ref.type}</span></td>
                    <td style="text-align: center; color: ${ref.votes >= 100 ? '#FFD700' : ref.votes >= 50 ? '#90EE90' : '#888'};">${ref.votes}</td>
                </tr>
            `).join('');
        }

        // ===== INLINE NON-CANONICAL SECTION FUNCTIONS =====

        // Populate the inline stats and table
        function populateInlineSection() {
            // Calculate stats
            const stats = {
                total: nonCanonRefs.length,
                deutero: nonCanonRefs.filter(r => r.type === 'Deuterocanonical').length,
                ethiopian: nonCanonRefs.filter(r => r.type === 'Ethiopian').length,
                gnostic: nonCanonRefs.filter(r => r.type === 'Gnostic').length,
                lost: nonCanonRefs.filter(r => r.type === 'Lost').length
            };

            // Update inline stat cards
            document.getElementById('inline-deutero-count').textContent = stats.deutero;
            document.getElementById('inline-ethiopian-count').textContent = stats.ethiopian;
            document.getElementById('inline-gnostic-count').textContent = stats.gnostic;
            document.getElementById('inline-lost-count').textContent = stats.lost;

            // Update total count
            document.getElementById('notable-count').textContent = stats.total;

            // Populate the table with all refs initially
            populateInlineTable('all');
        }

        // Filter and populate inline table
        function filterInlineTable(type) {
            // Update active tab styling
            document.querySelectorAll('.inline-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = btn.id.includes('all') ? 'rgba(255, 0, 0, 0.3)' :
                    btn.id.includes('deutero') ? 'rgba(147, 112, 219, 0.3)' :
                    btn.id.includes('ethiopian') ? 'rgba(255, 107, 157, 0.3)' :
                    btn.id.includes('gnostic') ? 'rgba(136, 136, 136, 0.3)' :
                    'rgba(255, 165, 0, 0.3)';
                btn.style.color = btn.id.includes('all') ? '#FF0000' :
                    btn.id.includes('deutero') ? '#9370DB' :
                    btn.id.includes('ethiopian') ? '#ff6b9d' :
                    btn.id.includes('gnostic') ? '#888888' : '#ffa500';
            });

            // Highlight selected tab
            if (type === 'all') {
                document.getElementById('inline-tab-all').classList.add('active');
                document.getElementById('inline-tab-all').style.background = '#FF0000';
                document.getElementById('inline-tab-all').style.color = 'white';
            } else if (type === 'Deuterocanonical') {
                document.getElementById('inline-tab-deutero').classList.add('active');
                document.getElementById('inline-tab-deutero').style.background = '#9370DB';
                document.getElementById('inline-tab-deutero').style.color = 'white';
            } else if (type === 'Ethiopian') {
                document.getElementById('inline-tab-ethiopian').classList.add('active');
                document.getElementById('inline-tab-ethiopian').style.background = '#ff6b9d';
                document.getElementById('inline-tab-ethiopian').style.color = 'white';
            } else if (type === 'Gnostic') {
                document.getElementById('inline-tab-gnostic').classList.add('active');
                document.getElementById('inline-tab-gnostic').style.background = '#333';
                document.getElementById('inline-tab-gnostic').style.color = 'white';
            } else if (type === 'Lost') {
                document.getElementById('inline-tab-lost').classList.add('active');
                document.getElementById('inline-tab-lost').style.background = '#ffa500';
                document.getElementById('inline-tab-lost').style.color = 'white';
            }

            populateInlineTable(type);
        }

        // Sorting state
        let currentSortColumn = 'votes';
        let currentSortDirection = 'desc';
        let currentFilterType = 'all';

        function sortInlineTable(column) {
            // Toggle direction if same column, otherwise default to desc for votes, asc for others
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = column === 'votes' ? 'desc' : 'asc';
            }

            // Update sort indicators
            ['nt', 'target', 'type', 'votes', 'desc'].forEach(col => {
                const indicator = document.getElementById(`sort-${col}`);
                if (indicator) {
                    if (col === column) {
                        indicator.textContent = currentSortDirection === 'asc' ? '‚Üë' : '‚Üì';
                        indicator.style.opacity = '1';
                    } else {
                        indicator.textContent = '‚Üï';
                        indicator.style.opacity = '0.5';
                    }
                }
            });

            populateInlineTable(currentFilterType);
        }

        function populateInlineTable(type) {
            currentFilterType = type;
            const tbody = document.getElementById('inline-table-body');

            // Filter refs
            const filtered = type === 'all'
                ? [...nonCanonRefs]
                : nonCanonRefs.filter(r => r.type === type);

            // Sort based on current sort settings
            filtered.sort((a, b) => {
                let aVal, bVal;

                switch (currentSortColumn) {
                    case 'nt':
                        aVal = a.nt.toLowerCase();
                        bVal = b.nt.toLowerCase();
                        break;
                    case 'target':
                        aVal = a.target.toLowerCase();
                        bVal = b.target.toLowerCase();
                        break;
                    case 'type':
                        aVal = a.type.toLowerCase();
                        bVal = b.type.toLowerCase();
                        break;
                    case 'votes':
                        aVal = a.votes;
                        bVal = b.votes;
                        break;
                    case 'desc':
                        aVal = (a.desc || '').toLowerCase();
                        bVal = (b.desc || '').toLowerCase();
                        break;
                    default:
                        aVal = a.votes;
                        bVal = b.votes;
                }

                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #888;">No cross-references found for this category</td></tr>';
                return;
            }

            const typeColors = {
                'Deuterocanonical': '#9370DB',
                'Ethiopian': '#ff6b9d',
                'Gnostic': '#888888',
                'Lost': '#ffa500'
            };

            // Generate description based on reference type and content
            function getDescription(ref) {
                if (ref.desc && ref.desc !== 'Cross-reference' && ref.desc !== 'Cross-reference to Deuterocanonical book' && ref.desc !== 'Cross-reference to Ethiopian book') {
                    return ref.desc;
                }
                // Generate meaningful description based on the target book
                const target = ref.target.toLowerCase();
                if (target.includes('1en.1')) return 'Prophecy about the Lord coming with holy ones';
                if (target.includes('1en.10')) return 'Angels bound in chains for judgment';
                if (target.includes('1en.14')) return 'Heavenly throne vision';
                if (target.includes('1en.15')) return 'Angels and marriage/spiritual beings';
                if (target.includes('1en.22')) return 'Souls of the dead and afterlife';
                if (target.includes('1en.62')) return 'Son of Man on throne of glory';
                if (target.includes('1en.69')) return 'Judgment given to Son of Man';
                if (target.includes('wis.')) return 'Wisdom tradition and divine knowledge';
                if (target.includes('sir.')) return 'Wisdom of Sirach teachings';
                if (target.includes('tob.')) return 'Story of Tobit and divine providence';
                if (target.includes('jdt.')) return 'Judith narrative and God\'s deliverance';
                if (target.includes('bar.')) return 'Baruch\'s prophecy and restoration';
                if (target.includes('1macc') || target.includes('2macc')) return 'Maccabean history and martyrdom';
                if (target.includes('3macc') || target.includes('4macc')) return 'Jewish persecution and faithfulness';
                if (target.includes('jub.')) return 'Book of Jubilees chronology';
                if (target.includes('pssol')) return 'Psalms of Solomon messianic themes';
                if (target.includes('t12pat')) return 'Testaments of the Twelve Patriarchs';
                return `Connection to ${ref.type} text`;
            }

            tbody.innerHTML = filtered.map(ref => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <td style="padding: 12px; vertical-align: top;">
                        <strong style="color: #00CED1; font-size: 1.05em;">${ref.nt}</strong>
                        ${ref.ntText ? `<div style="color: #aaa; font-style: italic; font-size: 0.85em; margin-top: 6px; line-height: 1.4;">"${ref.ntText}"</div>` : ''}
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <strong style="color: #FF6B6B; font-size: 1.05em;">${ref.target}</strong>
                        ${ref.targetText ? `<div style="color: #aaa; font-style: italic; font-size: 0.85em; margin-top: 6px; line-height: 1.4;">"${ref.targetText}"</div>` : ''}
                    </td>
                    <td style="padding: 12px; text-align: center; vertical-align: top;">
                        <span style="background: ${typeColors[ref.type] || '#888'}33; color: ${typeColors[ref.type] || '#888'};
                                     padding: 4px 10px; border-radius: 12px; font-size: 0.85em; border: 1px solid ${typeColors[ref.type] || '#888'};">
                            ${ref.type}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center; font-weight: bold; vertical-align: top;
                               color: ${ref.votes >= 100 ? '#FFD700' : ref.votes >= 50 ? '#ffa500' : '#ff6b6b'};">
                        ${ref.votes}
                    </td>
                    <td style="padding: 12px; color: #ccc; font-size: 0.9em; vertical-align: top; line-height: 1.4;">
                        ${getDescription(ref)}
                    </td>
                </tr>
            `).join('');
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const booksModal = document.getElementById('books-modal');
            const noncanonModal = document.getElementById('noncanon-modal');
            const textViewerModal = document.getElementById('text-viewer-modal');
            if (event.target == booksModal) {
                closeBooksModal();
            }
            if (event.target == noncanonModal) {
                closeNonCanonModal();
            }
            if (event.target == textViewerModal) {
                closeTextViewer();
            }
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>

    <footer style="background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%); border-top: 1px solid rgba(255, 107, 157, 0.2); padding: 20px 0; margin-top: 60px; text-align: center;">
        <div class="container">
            <p style="color: #888; margin: 10px 0; font-size: 0.9em;">
                PROJECT 159 | Truth Seeking Division
            </p>
            <div style="margin: 15px 0;">
                <a href="table-view.html" style="color: var(--accent-cyan); text-decoration: none; margin: 0 15px;">Cross-References</a>
                <a href="library.html" style="color: var(--accent-cyan); text-decoration: none; margin: 0 15px;">Library</a>
                <a href="timeline.html" style="color: var(--accent-cyan); text-decoration: none; margin: 0 15px;">Timeline</a>
                <a href="history.html" style="color: var(--accent-cyan); text-decoration: none; margin: 0 15px;">History</a>
            </div>
            <p style="color: #666; margin: 10px 0; font-size: 0.8em;">
                159 Books Cross-Reference Analysis | Built for biblical research and study
            </p>
        </div>
    </footer>
</body>
</html>
